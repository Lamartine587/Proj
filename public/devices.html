<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Security - Devices</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="min-h-screen">
    <script>
        if (!localStorage.getItem('token')) {
            window.location.href = '/login.html';
        }
    </script>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">Smart Home Security Dashboard</h1>
            <div class="flex items-center gap-4">
                <div class="relative">
                    <button id="notificationsButton" class="p-2 rounded-full hover:bg-gray-700 relative">
                        <i class="fas fa-bell text-gray-300"></i>
                        <span id="notificationCount" class="notification-badge hidden">0</span>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="userEmail" class="font-medium">Loading...</span>
                </div>
                <button id="logoutBtn" class="btn btn-secondary"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
            </div>
        </header>

        <nav class="flex border-b border-gray-700 mb-6">
            <a href="/dashboard.html" class="tab-button">Dashboard</a>
            <a href="/devices.html" class="tab-button active">Devices</a>
            <a href="/analytics.html" class="tab-button">Analytics</a>
            <a href="/settings.html" class="tab-button">Settings</a>
        </nav>

        <div id="devices">
            <div class="card mb-6">
                <div class="p-6">
                    <h2 class="text-xl font-semibold mb-4">Connected Devices</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Device Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Last Active</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="devicesTableBody" class="bg-gray-800 divide-y divide-gray-700">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading devices...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="loadingSpinner" class="spinner mt-4"></div>
                </div>
            </div>
        </div>

        <div id="toastContainer"></div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:3000';
        const POLL_INTERVAL = 2000;

        const devicesTableBody = document.getElementById('devicesTableBody');
        const notificationsButton = document.getElementById('notificationsButton');
        const notificationCount = document.getElementById('notificationCount');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const toastContainer = document.getElementById('toastContainer');
        const userEmailEl = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');

        let unreadNotifications = 0;
        let pollingInterval;

        async function initDevices() {
            await fetchUser();
            setupEventListeners();
            fetchDevices();
            startPolling();
        }

        async function fetchUser() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Failed to fetch user');
                userEmailEl.textContent = data.email;
            } catch (error) {
                console.error('Error fetching user:', error);
                showToast('Failed to load user data', 'error');
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }

        function setupEventListeners() {
            notificationsButton.addEventListener('click', showNotifications);
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            });
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(fetchDevices, POLL_INTERVAL);
        }

        async function fetchDevices() {
            try {
                toggleLoading(true);
                const response = await fetch(`${BACKEND_URL}/api/devices`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!response.ok) throw new Error('Failed to fetch devices');
                const devices = await response.json();
                updateDevicesTable(devices);
            } catch (error) {
                console.error('Error fetching devices:', error);
                showToast('Failed to fetch devices!', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        function updateDevicesTable(devices) {
            devicesTableBody.innerHTML = '';
            if (devices.length === 0) {
                devicesTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No devices found</td></tr>';
                return;
            }
            devices.forEach(device => {
                const isToggleable = ['smartLock', 'smartLight', 'siren'].includes(device.type);
                const toggleText = device.status === 'ON' || device.status === 'LOCKED' || device.status === 'ACTIVE' ? 'Turn Off' : 'Turn On';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="text" value="${device.name || device.deviceId}" data-device-id="${device.deviceId}" class="device-name-input w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                    </td>
                    <td class="px-6 py-4">${device.type || 'Unknown'}</td>
                    <td class="px-6 py-4">${device.status}</td>
                    <td class="px-6 py-4">${new Date(device.lastActivity).toLocaleString()}</td>
                    <td class="px-6 py-4">
                        <button class="btn btn-secondary btn-sm toggle-btn" data-device-id="${device.deviceId}" ${!isToggleable ? 'disabled' : ''}>
                            ${toggleText}
                        </button>
                    </td>
                `;
                devicesTableBody.appendChild(row);
            });

            document.querySelectorAll('.device-name-input').forEach(input => {
                input.addEventListener('change', async (e) => {
                    const deviceId = e.target.dataset.deviceId;
                    const newName = e.target.value.trim();
                    if (newName && newName.toLowerCase() !== 'undefine' && newName.toLowerCase() !== 'undefined') {
                        await renameDevice(deviceId, newName);
                    } else {
                        e.target.value = devices.find(d => d.deviceId === deviceId).name || deviceId;
                        showToast('Device name cannot be empty or invalid', 'error');
                    }
                });
            });

            document.querySelectorAll('.toggle-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const deviceId = e.target.dataset.deviceId;
                    await toggleDevice(deviceId);
                });
            });
        }

        async function renameDevice(deviceId, name) {
            try {
                toggleLoading(true);
                const response = await fetch(`${BACKEND_URL}/api/devices/${deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ name })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to rename device');
                }
                const device = await response.json();
                showToast(`Device renamed to ${device.name}`, 'success');
                fetchDevices();
            } catch (error) {
                console.error('Error renaming device:', error);
                showToast(error.message, 'error');
                fetchDevices();
            } finally {
                toggleLoading(false);
            }
        }

        async function toggleDevice(deviceId) {
            try {
                toggleLoading(true);
                const response = await fetch(`${BACKEND_URL}/api/devices/${deviceId}/toggle`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to toggle device');
                }
                const device = await response.json();
                showToast(`Device ${device.name} toggled to ${device.status}`, 'success');
                fetchDevices();
            } catch (error) {
                console.error('Error toggling device:', error);
                showToast(error.message, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        function showNotifications() {
            if (unreadNotifications === 0) {
                showToast('No new notifications', 'info');
                return;
            }
            const notificationList = document.createElement('div');
            notificationList.className = 'notification-list';
            for (let i = 0; i < unreadNotifications; i++) {
                const notificationItem = document.createElement('div');
                notificationItem.className = 'notification-item';
                notificationItem.textContent = `Notification ${i + 1}`;
                notificationList.appendChild(notificationItem);
            }
            showToast(notificationList, 'info', true);
            unreadNotifications = 0;
            updateNotificationCount();
        }

        function updateNotificationCount() {
            notificationCount.textContent = unreadNotifications > 0 ? unreadNotifications : '';
            notificationsButton.classList.toggle('has-notifications', unreadNotifications > 0);
        }

        function incrementNotificationCount() {
            unreadNotifications++;
            updateNotificationCount();
        }

        function showToast(message, type = 'info', persistent = false) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">${typeof message === 'string' ? message : message.outerHTML}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            if (!persistent) {
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }
            toastContainer.appendChild(toast);
            if (type === 'error') {
                console.error('Toast Error:', message);
            } else if (type === 'success') {
                console.log('Toast Success:', message);
            } else {
                console.log('Toast Info:', message);
            }
        }

        function toggleLoading(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', initDevices);
    </script>
</body>
</html>